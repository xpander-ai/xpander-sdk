name: Publish xpander-sdk to PyPI

on:
  push:
    branches:
      - main

jobs:
  publish:
    name: Build and Publish to PyPI
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.set_version.outputs.new_version }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine requests packaging jq

      - name: Get Latest Version from PyPI and Increment
        id: set_version
        run: |
          PACKAGE_NAME="xpander-sdk"
          PYPI_URL="https://pypi.org/pypi/${PACKAGE_NAME}/json"
          VERSION=$(curl -s $PYPI_URL | jq -r '.info.version' 2>/dev/null || echo "0.0.0")

          if [ "$VERSION" = "null" ] || [ -z "$VERSION" ] || [ "$VERSION" = "0.0.0" ]; then
            NEW_VERSION="2.0.0"
          else
            IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}

            if [ "$MAJOR" -lt 2 ]; then
              NEW_VERSION="2.0.0"
            elif [ "$MAJOR" -eq 2 ] && [ "$MINOR" -eq 0 ]; then
              PATCH=$((PATCH + 1))
              NEW_VERSION="2.0.$PATCH"
            else
              PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            fi
          fi

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Version in setup.py
        run: |
          sed -i "s/version=\"[0-9]\+\.[0-9]\+\.[0-9]\+\"/version=\"${{ steps.set_version.outputs.new_version }}\"/" setup.py

      - name: Build Package
        run: python -m build

      - name: Publish Package to PyPI
        env:
          TWINE_USERNAME: ${{ secrets.TWINE_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD }}
        run: twine upload dist/*

  tag:
    name: Create Git Tag
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Checkout using PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_ACTION_PAT }}

      - name: Create Git Tag and Push
        env:
          NEW_VERSION: ${{ needs.publish.outputs.new_version }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git tag "v$NEW_VERSION"
          git push origin "v$NEW_VERSION"

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [publish, tag]
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ needs.publish.outputs.new_version }}"
          name: "xpander-sdk v${{ needs.publish.outputs.new_version }}"
          body: |
            ðŸš€ **New release of xpander-sdk: v${{ needs.publish.outputs.new_version }}**
            
            ## What's New
            See the latest pull request for detailed changes.
            
            We're committed to updating the SDK often to provide the best experience and cutting-edge technologies for AI agents. This release includes the latest improvements, bug fixes, and new features to help you build powerful AI applications.
            
            ## Installation
            ```bash
            pip install xpander-sdk==${{ needs.publish.outputs.new_version }}
            ```
            
            ## Documentation
            Visit [xpander.ai](https://www.xpander.ai) for full documentation and examples.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
